name: Build

on:
  workflow_dispatch: {} # Enables the manual start

permissions:
  contents: write # Give permission to put the release into the repo

jobs:
  build-clients:
    runs-on: ubuntu-latest

    env:
      UserPass: '000' # Its password for pmos user

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pmbootstrap
        id: instpmb
        run: |
          git clone https://gitlab.postmarketos.org/postmarketOS/pmbootstrap.git
          mkdir -p ~/.local/bin
          ln -s "$PWD/pmbootstrap/pmbootstrap.py" ~/.local/bin/pmbootstrap
          PATH="$HOME/.local/bin:$PATH"
          pmbootstrap --version
        shell: bash

      - name: Copy config and init pmbootstrap
        id: init
        run: |
          mkdir -p ~/.config
          cp pmbootstrap_v3.cfg ~/.config/
          yes '' | pmbootstrap init || true
        shell: bash

      - name: Build image
        id: build
        run: |
          printf '%s\n%s\n' "${{ env.UserPass }}" "${{ env.UserPass }}" | pmbootstrap install || true
          pmbootstrap shutdown
          sudo mv ~/.local/var/pmbootstrap/chroot_rootfs_qcom-msm8953/boot/lk2nd.img ~/lk2nd.img
          sudo mv ~/.local/var/pmbootstrap/chroot_native/home/pmos/rootfs/qcom-msm8953.img ~/qcom-msm8953.img
        shell: bash

      - name: Compress images
        id: compress
        run: |
          zip -9 PMOS.zip lk2nd.img qcom-msm8953.img
        shell: bash

      - name: Create Release Info
        run: |
          DEVICE=$(grep '^device' pmbootstrap_v3.cfg | cut -d'=' -f2 | xargs)
          UI=$(grep '^ui' pmbootstrap_v3.cfg | cut -d'=' -f2 | xargs)
          SYSTEMD=$(grep '^systemd' pmbootstrap_v3.cfg | cut -d'=' -f2 | xargs)
          EXTRAS=$(grep '^extra_packages' pmbootstrap_v3.cfg | cut -d'=' -f2 | xargs | tr ',' ', ')

          {
            echo "Builded at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "Device: $DEVICE"
            echo "DE: $UI"
            echo "SystemD: $SYSTEMD"
            echo "Extra: $EXTRAS"
            echo "User Password: ${{ env.UserPass }}"
          } > release_body.txt
        shell: bash

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            PMOS.zip
          tag_name: PostmarketOS
          draft: false
          body_path: release_body.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


name: Build

on:
  workflow_dispatch: {} # Enables the manual start

permissions:
  contents: write # Give permission to put the release into the repo

jobs:
  build-clients:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pmbootstrap
        id: instpmb
        run: |
          git clone https://gitlab.postmarketos.org/postmarketOS/pmbootstrap.git
          mkdir -p ~/.local/bin
          ln -s "$PWD/pmbootstrap/pmbootstrap.py" ~/.local/bin/pmbootstrap
          PATH="$HOME/.local/bin:$PATH"
          pmbootstrap --version
        shell: bash

      - name: Copy config and init pmbootstrap
        id: init
        run: |
          mkdir -p ~/.config
          cp pmbootstrap_v3.cfg ~/.config/
          sudo apt install kpartx -y
          yes '' | pmbootstrap init || true
        shell: bash

      - name: Build image
        id: build
        run: |
          yes '000' | pmbootstrap install || true
          pmbootstrap shutdown
          sudo mv ~/.local/var/pmbootstrap/chroot_rootfs_qcom-msm8953/boot/lk2nd.img ~/lk2nd.img
          sudo mv ~/.local/var/pmbootstrap/chroot_native/home/pmos/rootfs/qcom-msm8953.img ~/qcom-msm8953.img
        shell: bash